{% extends 'base.html' %}
{% load static %}

{% block title %}设备统计分析 - 试验室管理系统{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 10px;
        margin-bottom: 1.5rem;
        transition: transform 0.2s ease-in-out;
    }
    
    .stats-card:hover {
        transform: translateY(-2px);
    }
    
    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }
    
    .stats-icon.primary {
        background: linear-gradient(135deg, #007bff, #0056b3);
    }
    
    .stats-icon.success {
        background: linear-gradient(135deg, #28a745, #1e7e34);
    }
    
    .stats-icon.warning {
        background: linear-gradient(135deg, #ffc107, #e0a800);
    }
    
    .stats-icon.danger {
        background: linear-gradient(135deg, #dc3545, #c82333);
    }
    
    .stats-icon.info {
        background: linear-gradient(135deg, #17a2b8, #138496);
    }
    
    .stats-icon.secondary {
        background: linear-gradient(135deg, #6c757d, #545b62);
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        line-height: 1;
    }
    
    .stats-label {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 1rem;
    }
    
    .chart-card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }
    
    .chart-card .card-header {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-bottom: 1px solid #dee2e6;
        border-radius: 10px 10px 0 0;
    }
    
    .progress-custom {
        height: 8px;
        border-radius: 4px;
    }
    
    .table-stats {
        font-size: 0.9rem;
    }
    
    .table-stats th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        color: #495057;
    }
    
    .equipment-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .status-available {
        background-color: #28a745;
    }
    
    .status-in-use {
        background-color: #ffc107;
    }
    
    .status-maintenance {
        background-color: #dc3545;
    }
    
    .status-retired {
        background-color: #6c757d;
    }
    
    .maintenance-alert {
        border-left: 4px solid #ffc107;
        background-color: #fff3cd;
        border-color: #ffeaa7;
    }
    
    .warranty-alert {
        border-left: 4px solid #dc3545;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }
    
    .quick-action-card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 10px;
        transition: transform 0.2s ease-in-out;
    }
    
    .quick-action-card:hover {
        transform: translateY(-2px);
    }
    
    .quick-action-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">设备统计分析</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">首页</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'equipment:index' %}">设备管理</a></li>
                    <li class="breadcrumb-item active">统计分析</li>
                </ol>
            </nav>
        </div>
        <div>
            <button class="btn btn-outline-primary" onclick="window.print()">
                <i class="fas fa-print"></i> 打印报告
            </button>
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="row">
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-icon primary mx-auto mb-3">
                        <i class="fas fa-desktop"></i>
                    </div>
                    <h3 class="stats-number text-primary">{{ total_equipment }}</h3>
                    <p class="stats-label">设备总数</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-icon success mx-auto mb-3">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 class="stats-number text-success">{{ available_equipment }}</h3>
                    <p class="stats-label">可用设备</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-icon warning mx-auto mb-3">
                        <i class="fas fa-play-circle"></i>
                    </div>
                    <h3 class="stats-number text-warning">{{ in_use_equipment }}</h3>
                    <p class="stats-label">使用中</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-icon danger mx-auto mb-3">
                        <i class="fas fa-wrench"></i>
                    </div>
                    <h3 class="stats-number text-danger">{{ maintenance_equipment }}</h3>
                    <p class="stats-label">维护中</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-icon info mx-auto mb-3">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="stats-number text-info">{{ maintenance_due_count }}</h3>
                    <p class="stats-label">需要维护</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-icon secondary mx-auto mb-3">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <h3 class="stats-number text-secondary">{{ retired_equipment }}</h3>
                    <p class="stats-label">已退役</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 警告信息 -->
    {% if maintenance_due_equipment %}
    <div class="alert maintenance-alert alert-dismissible fade show" role="alert">
        <h6 class="alert-heading">
            <i class="fas fa-exclamation-triangle"></i> 维护提醒
        </h6>
        <p>以下设备需要进行维护：</p>
        <ul class="mb-0">
            {% for equipment in maintenance_due_equipment %}
                <li>
                    <strong>{{ equipment.name }}</strong> ({{ equipment.equipment_id }}) 
                    - 下次维护日期：{{ equipment.next_maintenance_date|date:"Y-m-d" }}
                </li>
            {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    {% if warranty_expired_equipment %}
    <div class="alert warranty-alert alert-dismissible fade show" role="alert">
        <h6 class="alert-heading">
            <i class="fas fa-exclamation-circle"></i> 保修过期提醒
        </h6>
        <p>以下设备保修已过期：</p>
        <ul class="mb-0">
            {% for equipment in warranty_expired_equipment %}
                <li>
                    <strong>{{ equipment.name }}</strong> ({{ equipment.equipment_id }}) 
                    - 保修到期日期：{{ equipment.warranty_end_date|date:"Y-m-d" }}
                </li>
            {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <div class="row">
        <!-- 设备状态分布图 -->
        <div class="col-lg-6 mb-4">
            <div class="card chart-card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-pie"></i> 设备状态分布
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 制造商分布图 -->
        <div class="col-lg-6 mb-4">
            <div class="card chart-card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-bar"></i> 制造商分布
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="manufacturerChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 月度维护趋势 -->
        <div class="col-12 mb-4">
            <div class="card chart-card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-line"></i> 月度维护趋势
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="maintenanceTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 设备使用率统计 -->
        <div class="col-lg-8 mb-4">
            <div class="card chart-card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-bar"></i> 设备使用率统计
                    </h6>
                </div>
                <div class="card-body">
                    {% if equipment_usage_stats %}
                        <div class="table-responsive">
                            <table class="table table-hover table-stats">
                                <thead>
                                    <tr>
                                        <th>设备名称</th>
                                        <th>使用次数</th>
                                        <th>总使用时长</th>
                                        <th>平均使用时长</th>
                                        <th>使用率</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stat in equipment_usage_stats %}
                                    <tr>
                                        <td>
                                            <span class="equipment-status-indicator status-{{ stat.equipment.status }}"></span>
                                            <strong>{{ stat.equipment.name }}</strong>
                                            <br>
                                            <small class="text-muted">{{ stat.equipment.equipment_id }}</small>
                                        </td>
                                        <td>{{ stat.usage_count }}</td>
                                        <td>{{ stat.total_hours|floatformat:1 }} 小时</td>
                                        <td>{{ stat.avg_hours|floatformat:1 }} 小时</td>
                                        <td>
                                            <div class="progress progress-custom">
                                                <div class="progress-bar" role="progressbar" 
                                                     style="width: {{ stat.usage_rate }}%"
                                                     aria-valuenow="{{ stat.usage_rate }}" 
                                                     aria-valuemin="0" aria-valuemax="100">
                                                </div>
                                            </div>
                                            <small class="text-muted">{{ stat.usage_rate|floatformat:1 }}%</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                            <p class="text-muted">暂无使用统计数据</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 快速操作 -->
        <div class="col-lg-4 mb-4">
            <div class="card chart-card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-bolt"></i> 快速操作
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <div class="card quick-action-card text-center">
                                <div class="card-body">
                                    <div class="quick-action-icon text-primary">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <h6>新增设备</h6>
                                    <a href="{% url 'equipment:create' %}" class="btn btn-sm btn-primary">
                                        立即添加
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card quick-action-card text-center">
                                <div class="card-body">
                                    <div class="quick-action-icon text-success">
                                        <i class="fas fa-play"></i>
                                    </div>
                                    <h6>开始使用</h6>
                                    <a href="{% url 'equipment:usage_record_create' %}" class="btn btn-sm btn-success">
                                        记录使用
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card quick-action-card text-center">
                                <div class="card-body">
                                    <div class="quick-action-icon text-warning">
                                        <i class="fas fa-wrench"></i>
                                    </div>
                                    <h6>设备维护</h6>
                                    <a href="{% url 'equipment:maintenance_record_create' %}" class="btn btn-sm btn-warning">
                                        记录维护
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card quick-action-card text-center">
                                <div class="card-body">
                                    <div class="quick-action-icon text-info">
                                        <i class="fas fa-download"></i>
                                    </div>
                                    <h6>导出数据</h6>
                                    <a href="{% url 'equipment:export_equipment_csv' %}" class="btn btn-sm btn-info">
                                        导出CSV
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 维护费用统计 -->
            <div class="card chart-card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-dollar-sign"></i> 维护费用统计
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-12 mb-3">
                            <h4 class="text-primary mb-1">¥{{ total_maintenance_cost|floatformat:2 }}</h4>
                            <small class="text-muted">总维护费用</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <h5 class="text-success mb-1">¥{{ this_month_cost|floatformat:2 }}</h5>
                            <small class="text-muted">本月费用</small>
                        </div>
                        <div class="col-6">
                            <h5 class="text-warning mb-1">¥{{ avg_monthly_cost|floatformat:2 }}</h5>
                            <small class="text-muted">月均费用</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'vendor/chart.min.js' %}" defer></script>
<script>
$(document).ready(function() {
    // 设备状态分布饼图
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['可用', '使用中', '维护中', '已退役'],
            datasets: [{
                data: [{{ available_equipment }}, {{ in_use_equipment }}, {{ maintenance_equipment }}, {{ retired_equipment }}],
                backgroundColor: [
                    '#28a745',
                    '#ffc107',
                    '#dc3545',
                    '#6c757d'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // 制造商分布柱状图
    const manufacturerCtx = document.getElementById('manufacturerChart').getContext('2d');
    new Chart(manufacturerCtx, {
        type: 'bar',
        data: {
            labels: {{ manufacturer_labels|safe }},
            datasets: [{
                label: '设备数量',
                data: {{ manufacturer_data|safe }},
                backgroundColor: 'rgba(0, 123, 255, 0.8)',
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // 月度维护趋势线图
    const trendCtx = document.getElementById('maintenanceTrendChart').getContext('2d');
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: {{ maintenance_trend_labels|safe }},
            datasets: [{
                label: '维护次数',
                data: {{ maintenance_trend_data|safe }},
                borderColor: 'rgba(255, 193, 7, 1)',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
});
</script>
{% endblock %}
2# 试验室管理系统部署文档

## 特别说明：适用于电脑小白的Ubuntu局域网部署指南

本章节专门为没有Linux使用经验的用户编写，提供**极其详细**的Ubuntu环境下局域网部署步骤，包括每一步的具体命令、操作界面说明、可能遇到的问题及解决方法。

## 0. 什么是局域网部署？

简单来说，局域网部署就是把系统安装在一台电脑（服务器）上，然后同一网络内的其他电脑、手机、平板都能访问这个系统。

**你需要准备**：
1. 一台安装了Ubuntu系统的电脑（作为服务器）
2. 其他需要访问系统的设备（电脑、手机等）
3. 一个路由器（所有设备连接到同一个路由器）

## 0.2 查找服务器的IP地址

**操作目的**：获取服务器在局域网中的IP地址，其他设备将通过这个IP访问系统

**操作步骤**：

1. 在服务器上打开终端（`Ctrl + Alt + T`）
2. 输入以下命令，然后按下 `Enter` 键：
   ```bash
   ip addr show
   ```
3. 在输出结果中，找到类似 `192.168.x.x` 或 `10.0.x.x` 格式的IP地址
   - 通常会在 `wlp2s0`（无线网卡）或 `enp0s3`（有线网卡）部分
   - 示例：`inet 192.168.8.215/24`，其中 `192.168.8.215` 就是服务器的IP地址
4. **记下来这个IP地址**，后面会经常用到！

**简单方法**：也可以使用以下命令直接查看IP地址：
```bash
hostname -I
```

这个命令会直接显示服务器的IP地址，更容易找到。

## 0.1 安装Ubuntu系统（如果还没安装）

如果你还没有安装Ubuntu系统，可以按照以下简单步骤安装：

1. 从[Ubuntu官网](https://ubuntu.com/download/desktop)下载Ubuntu Desktop镜像文件
2. 使用[Rufus](https://rufus.ie/)制作U盘启动盘
3. 将U盘插入要安装Ubuntu的电脑，开机按F12或Del键进入BIOS，选择U盘启动
4. 按照界面提示安装Ubuntu（选择"安装Ubuntu"，按照默认选项下一步即可）

---

## 1. 环境要求

### 1.1 硬件要求
- **CPU**：2核及以上
- **内存**：4GB及以上
- **磁盘空间**：50GB及以上可用空间

### 1.2 软件要求
- **操作系统**：Windows Server 2016+ / CentOS 7+ / Ubuntu 18.04+（推荐Ubuntu 22.04 LTS）
- **Python**：3.8+ （推荐3.10）
- **数据库**：MySQL 5.7+ 或 MariaDB 10.3+
- **缓存**：Redis 5.0+（可选，用于提高性能）
- **Web服务器**：Nginx 1.16+ 或 Apache 2.4+
- **WSGI服务器**：Gunicorn 20.0+ 或 uWSGI 2.0+

## 2. 部署前准备

### 2.1 安装系统依赖

#### Ubuntu/Debian（详细步骤）

**操作目的**：安装系统所需的基础软件包

**操作步骤**：

1. **打开终端**：
   - 按下键盘上的 `Ctrl + Alt + T` 组合键，会弹出一个黑色的终端窗口
   - 这就是我们在Ubuntu中输入命令的地方

2. **更新系统**：
   - 在终端中输入以下命令，然后按下 `Enter` 键：
     ```bash
     sudo apt update
     ```
   - 系统会提示输入密码，输入你的Ubuntu登录密码（输入时不会显示字符，这是正常的），然后按下 `Enter` 键
   - 等待系统更新软件列表（可能需要几分钟）

3. **安装依赖包**：
   - 输入以下命令，然后按下 `Enter` 键：
     ```bash
     sudo apt install -y python3 python3-pip python3-venv python3-dev \
         mysql-server redis-server nginx \
         build-essential libmysqlclient-dev libssl-dev \
         libffi-dev zlib1g-dev libbz2-dev libreadline-dev \
         libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
         xz-utils tk-dev liblzma-dev
     ```
   - 系统会询问是否继续安装，输入 `y` 然后按下 `Enter` 键
   - 等待系统安装所有依赖包（可能需要10-15分钟）

4. **验证安装**：
   - 安装完成后，输入以下命令检查Python版本：
     ```bash
     python3 --version
     ```
   - 如果显示 `Python 3.8.10` 或更高版本，说明安装成功

**可能遇到的问题**：
- **问题**：输入密码后提示 "permission denied"
  **解决方法**：确保你使用的是具有管理员权限的用户登录Ubuntu

- **问题**：安装过程中网络断开
  **解决方法**：检查网络连接，然后重新运行安装命令

#### Ubuntu/Debian（快速命令）
```bash
sudo apt update
sudo apt install -y python3 python3-pip python3-venv python3-dev \
    mysql-server redis-server nginx \
    build-essential libmysqlclient-dev libssl-dev \
    libffi-dev zlib1g-dev libbz2-dev libreadline-dev \
    libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
    xz-utils tk-dev liblzma-dev
```

#### CentOS/RHEL
```bash
sudo yum update
sudo yum install -y python3 python3-pip python3-venv python3-devel \
    mysql-server redis nginx \
    gcc gcc-c++ make openssl-devel \
    libffi-devel zlib-devel bzip2-devel readline-devel \
    sqlite-devel wget curl llvm ncurses-devel ncursesw-devel \
    xz-devel tk-devel lzma-devel
```

#### Windows Server
1. 安装 Python 3.8+：从 [Python官网](https://www.python.org/downloads/windows/) 下载并安装
2. 安装 MySQL：从 [MySQL官网](https://dev.mysql.com/downloads/mysql/) 下载并安装
3. 安装 Redis：从 [Redis官网](https://redis.io/download) 下载并安装
4. 安装 Nginx：从 [Nginx官网](http://nginx.org/en/download.html) 下载并安装

### 2.2 配置数据库

#### 启动数据库服务
```bash
# Ubuntu/Debian
sudo systemctl start mysql
sudo systemctl enable mysql

# CentOS/RHEL
sudo systemctl start mysqld
sudo systemctl enable mysqld

# Windows
# 请在服务管理器中启动MySQL服务
```

#### 创建数据库和用户
1. 登录MySQL：
```bash
mysql -u root -p
```

2. 创建数据库：
```sql
CREATE DATABASE laboratory_test_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

3. 创建用户并授权（使用指定的密码）：
```sql
CREATE USER 'lab_user'@'localhost' IDENTIFIED BY 'Ymzlj729928@';
GRANT ALL PRIVILEGES ON laboratory_test_management.* TO 'lab_user'@'localhost';
FLUSH PRIVILEGES;
```

### 2.3 配置Redis（可选）

#### 启动Redis服务
```bash
# Ubuntu/Debian
sudo systemctl start redis-server
sudo systemctl enable redis-server

# CentOS/RHEL
sudo systemctl start redis
sudo systemctl enable redis

# Windows
# 请在服务管理器中启动Redis服务
```

## 3. 项目部署

### 3.1 克隆代码
```bash
# 创建项目目录
sudo mkdir -p /opt
sudo chmod 777 /opt

# 克隆代码
sudo git clone <项目仓库地址> .
sudo chown -R <username>:<username> /opt/laboratory_management
```

### 3.2 创建虚拟环境并安装依赖
```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 升级pip
pip install --upgrade pip

# 安装项目依赖
pip install -r requirements.txt
```

### 3.3 配置项目

#### 修改配置文件
1. 复制配置文件模板：
```bash
cp laboratory_management/settings.py.example laboratory_management/settings.py
```

2. 编辑配置文件：
```bash
vi laboratory_management/settings.py
```

3. 关键配置项修改：

| 配置项 | 说明 | 示例值 |
|--------|------|--------|
| `DEBUG` | 调试模式，生产环境设为False | `False` |
| `ALLOWED_HOSTS` | 允许访问的主机名/IP（**局域网部署必须配置**） | `['192.168.187.128', 'localhost']` |
| `SECRET_KEY` | 密钥，用于加密 | 生成一个随机字符串 |
| `DATABASES` | 数据库配置 | 见下方示例 |
| `CACHES` | 缓存配置 | 见下方示例 |
| `CELERY_BROKER_URL` | Celery消息队列 | `redis://localhost:6379/0` |
| `CELERY_RESULT_BACKEND` | Celery结果存储 | `redis://localhost:6379/0` |

**重要：ALLOWED_HOSTS配置**
在局域网环境下，你必须将服务器的IP地址添加到ALLOWED_HOSTS中，否则其他设备无法访问系统。

例如，当前Ubuntu服务器的IP是`192.168.187.128`，那么ALLOWED_HOSTS应该配置为：
```python
ALLOWED_HOSTS = ['192.168.187.128', 'localhost']
```

**简单方法**：如果你不确定IP地址，或者想允许所有设备访问，也可以使用：
```python
ALLOWED_HOSTS = ['*']
```

这表示允许所有IP地址访问系统，适合测试环境使用。

### 3.3.1 CSRF 与 CORS（局域网登录必读）

在局域网环境下，后台登录可能提示 **CSRF token missing or incorrect**。请在 `settings.py` 中加入以下配置，以你的服务器 IP 为准：

```python
CSRF_TRUSTED_ORIGINS = [
    'http://192.168.187.128',
    'https://192.168.187.128',
]

# 若存在跨源 API 访问需求，简单方式：
CORS_ALLOW_ALL_ORIGINS = True
# 更安全的白名单做法：
# CORS_ALLOWED_ORIGINS = [
#     'http://192.168.187.128',
#     'https://192.168.187.128',
# ]
```

说明：
- CSRF 需要“带协议的域名/IP”白名单，否则登录可能失败。
- 如果仅服务端渲染页面，CORS 可不启用；如需外部前端或移动端访问 API，优先使用白名单而不是全放开。

4. 数据库配置示例（使用指定的账号和密码）：
```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'laboratory_test_management',
        'USER': 'lab_user',
        'PASSWORD': 'Ymzlj729928@',
        'HOST': 'localhost',
        'PORT': '3306',
        'OPTIONS': {
            'init_command': "SET sql_mode='STRICT_TRANS_TABLES'",
        },
    }
}
```

5. 缓存配置示例：
```python
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/1',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}
```

### 3.4 运行数据库迁移
```bash
# 生成迁移文件
python manage.py makemigrations

# 应用迁移
python manage.py migrate
```

### 3.5 创建超级用户
```bash
python manage.py createsuperuser
```

### 3.6 收集静态资源
```bash
python manage.py collectstatic --noinput
```

## 4. 配置Web服务器

### 4.1 配置Nginx

1. 创建Nginx配置文件：
```bash
sudo vi /etc/nginx/conf.d/laboratory_management.conf
```

2. 写入配置：
```nginx
server {
    listen 80;
    server_name 192.168.187.128;  # 当前Ubuntu服务器的IP地址
    charset utf-8;

    # 静态文件配置
    location /static/ {
        alias /opt/laboratory_management/staticfiles/;
        expires 30d;
        access_log off;
    }

    # 媒体文件配置
    location /media/ {
        alias /opt/laboratory_management/media/;
        expires 30d;
        access_log off;
    }

    # 主应用配置
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 错误页面配置
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
```

**重要修改**：
- 将 `server_name` 改为你的服务器IP地址（例如：`192.168.187.128`）
- 这确保Nginx能正确处理来自局域网其他设备的请求

**简单方法**：如果你想允许通过任何IP访问，也可以使用：
```nginx
server_name _;
```

这表示Nginx会处理所有指向该服务器的请求。

3. 测试Nginx配置：
```bash
sudo nginx -t
```

4. 重启Nginx：
```bash
sudo systemctl restart nginx
sudo systemctl enable nginx
```

### 4.1.1 反向代理后端绑定方式（选一种即可）

为了避免配置不一致导致 502 或无法连接，请在后端与 Nginx 之间选择一种绑定方式，并保持一致：

**方案A（推荐给新手，使用 TCP 端口 8000）**

1. 修改 `gunicorn_start.sh` 示例，将 `--bind` 改为端口：
```
# ... 保持前置变量不变
exec venv/bin/gunicorn ${DJANGO_WSGI_MODULE}:application \
  --name $NAME \
  --workers $NUM_WORKERS \
  --user=$USER --group=$GROUP \
  --bind 127.0.0.1:8000 \
  --log-level=info \
  --log-file=-  \
  --timeout=300
```
2. 保持 Nginx：
```nginx
location / {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

**方案B（使用 UNIX Socket，性能更好但略复杂）**

1. 保持 `gunicorn_start.sh` 的 `--bind=unix:/opt/laboratory_management/run/gunicorn.sock`
2. 将 Nginx 改为使用 socket：
```
upstream gunicorn_backend {
    server unix:/opt/laboratory_management/run/gunicorn.sock;
}
server {
    listen 80;
    server_name 192.168.187.128;  # 或 server_name _;
    location / {
        proxy_pass http://gunicorn_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

> 提示：两套方式不要混用，任选其一并保持与 Nginx 配置一致。

### 4.2 配置Gunicorn

1. 创建Gunicorn启动脚本：
```bash
vi /opt/laboratory_management/gunicorn_start.sh
```

2. 写入脚本内容：
```bash
#!/bin/bash

NAME="laboratory_management"
DJANGODIR=/opt/laboratory_management
SOCKFILE=/opt/laboratory_management/run/gunicorn.sock
USER=ymz
GROUP=ymz
NUM_WORKERS=3
DJANGO_SETTINGS_MODULE=laboratory_management.settings
DJANGO_WSGI_MODULE=laboratory_management.wsgi

echo "Starting $NAME as `whoami`"

# 激活虚拟环境
cd $DJANGODIR
source venv/bin/activate

export DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE
export PYTHONPATH=$DJANGODIR:$PYTHONPATH

# 创建运行目录
RUNDIR=$(dirname $SOCKFILE)
test -d $RUNDIR || mkdir -p $RUNDIR

# 启动Gunicorn
exec venv/bin/gunicorn ${DJANGO_WSGI_MODULE}:application \
  --name $NAME \
  --workers $NUM_WORKERS \
  --user=$USER --group=$GROUP \
  --bind=unix:$SOCKFILE \
  --log-level=info \
  --log-file=-  \
  --timeout=300
```

3. 给脚本添加执行权限：
```bash
chmod +x /opt/laboratory_management/gunicorn_start.sh
```

### 4.3 配置Systemd服务

#### Gunicorn服务
1. 创建Systemd服务文件：
```bash
sudo vi /etc/systemd/system/gunicorn_lab.service
```

2. 写入服务配置：
```ini
[Unit]
Description=Gunicorn instance to serve laboratory_management
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/opt/laboratory_management
ExecStart=/opt/laboratory_management/gunicorn_start.sh
Restart=always

[Install]
WantedBy=multi-user.target
```

#### Celery Worker服务
1. 创建Celery Worker服务文件：
```bash
sudo vi /etc/systemd/system/celery_lab_worker.service
```

2. 写入服务配置：
```ini
[Unit]
Description=Celery worker for laboratory_management
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/opt/laboratory_management
Environment="PATH=/opt/laboratory_management/venv/bin"
ExecStart=/opt/laboratory_management/venv/bin/celery -A laboratory_management worker -l info
Restart=always

[Install]
WantedBy=multi-user.target
```

#### Celery Beat服务
1. 创建Celery Beat服务文件：
```bash
sudo vi /etc/systemd/system/celery_lab_beat.service
```

2. 写入服务配置：
```ini
[Unit]
Description=Celery beat for laboratory_management
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/opt/laboratory_management
Environment="PATH=/opt/laboratory_management/venv/bin"
ExecStart=/opt/laboratory_management/venv/bin/celery -A laboratory_management beat -l info
Restart=always

[Install]
WantedBy=multi-user.target
```

### 4.4 启动服务

1. 重新加载Systemd配置：
```bash
sudo systemctl daemon-reload
```

2. 启动并启用所有服务：
```bash
sudo systemctl start gunicorn_lab celery_lab_worker celery_lab_beat
sudo systemctl enable gunicorn_lab celery_lab_worker celery_lab_beat
```

3. 检查服务状态：
```bash
sudo systemctl status gunicorn_lab celery_lab_worker celery_lab_beat
```

## 5. 部署后验证

### 5.1 访问网站

**从服务器本地访问**：
- 主站点：`http://localhost` 或 `http://127.0.0.1`
- 管理后台：`http://localhost/admin` 或 `http://127.0.0.1/admin`

**从局域网其他设备访问**：
- 主站点：`http://192.168.187.128`（当前Ubuntu服务器的IP地址）
- 管理后台：`http://192.168.187.128/admin`（当前Ubuntu服务器的IP地址）

### 5.1.1 局域网登录验证清单

- 用浏览器访问：`http://192.168.187.128` 与 `http://192.168.187.128/admin`
- 若登录出现 CSRF 提示：确认 `settings.py` 的 `CSRF_TRUSTED_ORIGINS` 已包含 `http://192.168.187.128`
- 若样式丢失或资源 404：确保已执行 `python manage.py collectstatic --noinput`，并检查 Nginx 的静态目录配置
- 命令行快速验证：
  ```bash
  curl -I http://192.168.187.128
  ```

**测试不同设备**：
1. 使用电脑访问：在浏览器中输入服务器IP地址
2. 使用手机/平板访问：确保设备连接到同一WiFi，然后在浏览器中输入服务器IP地址
3. 登录测试：使用之前创建的超级用户登录管理后台，验证系统是否正常运行

### 5.2 简单测试部署（适合初学者）

如果你觉得上面的部署步骤太复杂，可以先使用Django自带的开发服务器进行测试部署：

1. 确保在项目根目录下，并且虚拟环境已激活
2. 运行以下命令：
   ```bash
   python manage.py runserver 0.0.0.0:8000
   ```
3. 然后在其他设备上访问：`http://服务器IP:8000`

**注意**：这是测试环境，不适合生产使用，但对于初学者来说更容易上手和测试。

### 5.3 检查日志

1. Nginx日志：
```bash
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

2. 应用日志：
```bash
tail -f /opt/laboratory_management/logs/django.log
```

3. Gunicorn日志：
```bash
sudo journalctl -u gunicorn_lab -f
```

4. Celery日志：
```bash
sudo journalctl -u celery_lab_worker -f
sudo journalctl -u celery_lab_beat -f
```

### 5.4 数据库连接验证

**操作目的**：验证数据库连接是否正确配置，确保系统能够正常访问数据库

**操作步骤**：

1. **使用Django的shell验证数据库连接**：
   ```bash
   # 进入项目根目录
   cd /opt/laboratory_management
   
   # 激活虚拟环境
   source venv/bin/activate
   
   # 进入Django shell
   python manage.py shell
   ```

2. **在Django shell中执行以下命令**：
   ```python
   # 导入Django的数据库连接模块
   from django.db import connection
   
   # 执行简单的SQL查询
   with connection.cursor() as cursor:
       cursor.execute("SELECT 1")
       result = cursor.fetchone()
   
   print(result)  # 预期输出：(1,)
   ```

3. **如果输出 `(1,)`**，说明数据库连接正常！

4. **如果出现错误**，请检查以下内容：
   - 数据库服务是否正在运行：`sudo systemctl status mysql`
   - 数据库配置是否正确：检查settings.py中的DATABASES配置
   - 数据库用户权限是否正确：使用MySQL客户端登录验证
   - 数据库是否存在：`SHOW DATABASES;`

5. **使用MySQL客户端直接验证**：
   ```bash
   # 使用指定的账号和密码登录MySQL
   mysql -u lab_user -p
   # 输入密码：Ymzlj729928@
   
   # 查看数据库
   SHOW DATABASES;
   
   # 切换到项目数据库
   USE laboratory_test_management;
   
   # 查看表
   SHOW TABLES;
   ```

6. **检查数据库日志**：
   ```bash
   sudo tail -f /var/log/mysql/error.log
   ```

通过以上步骤，你可以确保数据库连接配置正确，系统能够正常访问数据库。

## 6. 安全配置

### 6.1 配置防火墙

#### Ubuntu/Debian
```bash
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
# 若使用开发服务器联调，请放行 8000 端口
sudo ufw allow 8000/tcp
sudo ufw status
```

#### CentOS/RHEL
```bash
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
sudo firewall-cmd --list-all
```

### 6.2 配置HTTPS

1. 安装Certbot：
```bash
# Ubuntu/Debian
sudo apt install -y certbot python3-certbot-nginx

# CentOS/RHEL
sudo yum install -y certbot python3-certbot-nginx
```

2. 申请SSL证书：
```bash
sudo certbot --nginx -d example.com
```

3. 验证HTTPS配置：
```bash
https://example.com
```

## 7. 定期维护

### 7.1 数据库备份

创建备份脚本：
```bash
vi /opt/laboratory_management/backup_db.sh
```

脚本内容：
```bash
#!/bin/bash

DB_NAME="laboratory_test_management"
DB_USER="lab_user"
DB_PASS="Ymzlj729928@"
BACKUP_DIR="/opt/laboratory_management/backups"
DATE=$(date +"%Y%m%d_%H%M%S")

# 创建备份目录
test -d $BACKUP_DIR || mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u$DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/${DB_NAME}_${DATE}.sql

# 压缩备份文件
gzip $BACKUP_DIR/${DB_NAME}_${DATE}.sql

# 删除7天前的备份文件
find $BACKUP_DIR -name "${DB_NAME}_*.sql.gz" -mtime +7 -delete
```

添加执行权限并设置定时任务：
```bash
chmod +x /opt/laboratory_management/backup_db.sh
crontab -e
```

添加定时任务（每天凌晨2点执行）：
```
0 2 * * * /opt/laboratory_management/backup_db.sh
```

### 7.2 日志管理

1. 配置日志轮转：
```bash
sudo vi /etc/logrotate.d/laboratory_management
```

2. 写入配置：
```
/opt/laboratory_management/logs/django.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
}
```

### 7.3 定期更新

1. 更新代码：
```bash
cd /opt/laboratory_management
git pull origin main
```

2. 更新依赖：
```bash
pip install --upgrade -r requirements.txt
```

3. 运行迁移：
```bash
python manage.py migrate
```

4. 收集静态资源：
```bash
python manage.py collectstatic --noinput
```

5. 重启服务：
```bash
sudo systemctl restart gunicorn_lab celery_lab_worker celery_lab_beat
```

## 8. 常见问题及解决方案

### 8.1 502 Bad Gateway

**问题**：访问网站时出现502错误

**解决方案**：
1. 检查Gunicorn服务是否正常运行：
   ```bash
   sudo systemctl status gunicorn_lab
   ```

2. 检查Gunicorn日志：
   ```bash
   sudo journalctl -u gunicorn_lab -f
   ```

3. 检查Nginx配置是否正确：
   ```bash
   sudo nginx -t
   ```

4. 检查SOCK文件权限：
   ```bash
   ls -la /opt/laboratory_management/run/gunicorn.sock
   ```

### 8.2 局域网访问时样式丢失

**问题**：服务器本地访问正常，但其他设备访问时样式（CSS）丢失

**解决方案**：

1. **检查静态资源配置**：
   - 确保已运行 `collectstatic` 命令：
     ```bash
     python manage.py collectstatic --noinput
     ```
   - 检查静态资源目录权限：
     ```bash
     sudo chown -R www-data:www-data /opt/laboratory_management/staticfiles/
     ```

2. **检查Nginx静态资源配置**：
   - 确认Nginx配置中的静态资源路径正确：
     ```bash
     sudo vi /etc/nginx/conf.d/laboratory_management.conf
     ```
   - 确保 `location /static/` 配置正确指向 `staticfiles` 目录

3. **检查ALLOWED_HOSTS配置**：
   - 确保服务器IP地址已添加到ALLOWED_HOSTS中：
     ```bash
     vi /opt/laboratory_management/laboratory_management/settings.py
     ```
   - 正确配置示例：
     ```python
     ALLOWED_HOSTS = ['192.168.8.215', 'localhost']
     ```

4. **检查CSS资源路径**：
   - 查看浏览器开发者工具（按F12）的Network面板
   - 检查CSS文件是否404错误
   - 如果使用CDN资源，确保设备能正常访问互联网

5. **简单测试解决方案**：
   - 如果使用Django开发服务器，确保使用了 `0.0.0.0:8000` 监听所有IP：
     ```bash
     python manage.py runserver 0.0.0.0:8000
     ```

### 8.3 静态资源无法访问

**问题**：网站可以访问，但CSS、JavaScript等静态资源无法加载

**解决方案**：
1. 检查是否运行了`collectstatic`命令：
   ```bash
   ls -la /opt/laboratory_management/staticfiles/
   ```

2. 检查Nginx配置中的静态资源路径是否正确：
   ```bash
   sudo vi /etc/nginx/conf.d/laboratory_management.conf
   ```

3. 检查静态资源文件权限：
   ```bash
   sudo chown -R www-data:www-data /opt/laboratory_management/staticfiles/
   ```

### 8.4 数据库连接错误

**问题**：无法连接到数据库

**解决方案**：
1. 检查数据库服务是否正常运行：
   ```bash
   sudo systemctl status mysql
   ```

2. 检查数据库配置是否正确：
   ```bash
   vi /opt/laboratory_management/laboratory_management/settings.py
   ```

3. 检查数据库用户权限：
   ```sql
   SHOW GRANTS FOR 'lab_user'@'localhost';
   ```

### 8.5 Celery任务不执行

**问题**：Celery任务提交后不执行

**解决方案**：
1. 检查Celery Worker服务是否正常运行：
   ```bash
   sudo systemctl status celery_lab_worker
   ```

2. 检查Celery日志：
   ```bash
   sudo journalctl -u celery_lab_worker -f
   ```

3. 检查Redis服务是否正常运行：
   ```bash
   sudo systemctl status redis-server
   ```

## 9. 局域网部署快速总结

**对于电脑小白的10步快速部署指南**：

1. ✅ 安装Ubuntu系统（如果还没安装）
2. ✅ 打开终端（Ctrl + Alt + T）
3. ✅ 查找服务器IP地址（`hostname -I`）并记下来
4. ✅ 安装依赖包（按照2.1节的命令）
5. ✅ 配置数据库（创建数据库和用户）
6. ✅ 克隆项目代码
7. ✅ 配置项目：
   - 修改settings.py中的ALLOWED_HOSTS为你的服务器IP
   - 配置数据库连接
8. ✅ 运行数据库迁移和收集静态资源
9. ✅ 配置Nginx和Gunicorn
10. ✅ 启动服务并测试访问

**测试部署（简单方法）**：
如果觉得上面的步骤太复杂，可以先使用Django自带的开发服务器测试：
```bash
python manage.py runserver 0.0.0.0:8000
```

然后在其他设备上访问：`http://你的服务器IP:8000`

## 10. 快速故障排除指南

| 问题现象 | 可能原因 | 快速解决方法 |
|----------|----------|--------------|
| 无法访问网站 | IP地址错误 | 重新检查服务器IP地址 |
| 样式丢失 | 静态资源未收集 | 运行 `python manage.py collectstatic --noinput` |
| 502错误 | Gunicorn未启动 | 运行 `sudo systemctl start gunicorn_lab` |
| 数据库连接错误 | 密码错误 | 检查settings.py中的数据库密码 |
| 其他设备无法访问 | ALLOWED_HOSTS配置错误 | 将服务器IP添加到ALLOWED_HOSTS中 |

## 11. 联系方式

- 项目负责人：[负责人姓名]
- 技术支持：[支持邮箱/电话]
- 文档地址：[文档链接]
- 问题反馈：[问题跟踪系统链接]

---

部署完成后，请定期检查系统运行状态，确保系统稳定运行。如有任何问题，请参考本文档或联系技术支持团队。

**恭喜你！** 如果你按照本指南完成了部署，那么你已经成功在Ubuntu系统上部署了试验室管理系统，并且可以在局域网内的所有设备上访问它。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
